// src/components/app/settings/GeneralSettings.jsx
import React, { useState } from 'react';
import { useHospitalInfo } from '../../../contexts/HospitalContext';
import { useNavigate } from 'react-router-dom';
import { updateHospitalInfo } from '../../../api/hospital';

const GeneralSettings = () => {
  const { hospitalInfo, setHospitalInfo } = useHospitalInfo();
  const [editMode, setEditMode] = useState(false);
  const [hospital, setHospital] = useState({ ...hospitalInfo });
  const [system, setSystem] = useState({
    notify: 'ON',
    interval: 15,
    emr: 'ÏÇ¨Ïö©',
    autoBackup: true,
    darkMode: false,
    language: 'ko',
    timezone: 'Asia/Seoul',
  });
  const [activeTab, setActiveTab] = useState('general');
  const [showAddCard, setShowAddCard] = useState(false);
  const [newCard, setNewCard] = useState({
    title: '',
    description: '',
    icon: 'üîß',
    path: '',
    color: 'blue',
  });
  const navigate = useNavigate();
  const [editQuickSettings, setEditQuickSettings] = useState(false);

  const [quickSettings, setQuickSettings] = useState([
    {
      id: 1,
      title: 'Î≥ëÏõê Ï†ïÎ≥¥',
      description: 'Í∏∞Î≥∏ Ï†ïÎ≥¥ Í¥ÄÎ¶¨',
      icon: 'üè•',
      path: '/Dashboard/hospital-info',
      color: 'blue',
    },
    {
      id: 2,
      title: 'ÏÇ¨Ïö©Ïûê Í∂åÌïú',
      description: 'Í∂åÌïú Î∞è Ïó≠Ìï† Í¥ÄÎ¶¨',
      icon: 'üë•',
      path: '/Dashboard/user-permissions',
      color: 'green',
    },
    {
      id: 3,
      title: 'Ï±óÎ¥á ÏÑ§Ï†ï',
      description: 'AI Ï±óÎ¥á Í¥ÄÎ¶¨',
      icon: 'ü§ñ',
      path: '/Dashboard/chatbot-settings',
      color: 'purple',
    },
  ]);

  const saveHospitalInfo = async () => {
    try {
      await updateHospitalInfo(hospital);
      setHospitalInfo({ ...hospital });
      setEditMode(false);
      alert('Î≥ëÏõê Ï†ïÎ≥¥Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
    } catch (err) {
      console.error(err);
      alert('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  const cancelEdit = () => {
    setHospital({ ...hospitalInfo });
    setEditMode(false);
  };

  const saveSystemSettings = () => {
    alert('ÏãúÏä§ÌÖú ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
  };

  const handleAddCard = () => {
    setShowAddCard(true);
    setNewCard({
      title: '',
      description: '',
      icon: 'üîß',
      path: '',
      color: 'blue',
    });
  };

  const handleSaveNewCard = () => {
    if (
      !newCard.title.trim() ||
      !newCard.description.trim() ||
      !newCard.path.trim()
    ) {
      alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    const cardToAdd = {
      id: Date.now(),
      title: newCard.title,
      description: newCard.description,
      icon: newCard.icon,
      path: newCard.path,
      color: newCard.color,
    };

    setQuickSettings([...quickSettings, cardToAdd]);
    setShowAddCard(false);
    setNewCard({
      title: '',
      description: '',
      icon: 'üîß',
      path: '',
      color: 'blue',
    });
  };

  const handleDeleteCard = (id) => {
    if (window.confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
      setQuickSettings(quickSettings.filter((card) => card.id !== id));
    }
  };

  const handleCardClick = (card) => {
    navigate(card.path);
  };

  const getColorClasses = (color) => {
    const colorMap = {
      blue: 'bg-blue-100 text-blue-600',
      green: 'bg-green-100 text-green-600',
      purple: 'bg-purple-100 text-purple-600',
      red: 'bg-red-100 text-red-600',
      yellow: 'bg-yellow-100 text-yellow-600',
      indigo: 'bg-indigo-100 text-indigo-600',
    };
    return colorMap[color] || colorMap.blue;
  };

  const tabs = [
    { id: 'general', label: 'Í∏∞Î≥∏ ÏÑ§Ï†ï', icon: '‚öôÔ∏è' },
    { id: 'hospital', label: 'Î≥ëÏõê Í¥ÄÎ¶¨', icon: 'üè•' },
    { id: 'users', label: 'ÏÇ¨Ïö©Ïûê Í¥ÄÎ¶¨', icon: 'üë•' },
  ];

  const handleEditQuickSettings = () => {
    setEditQuickSettings(!editQuickSettings);
    setShowAddCard(false);
  };

  const renderGeneralTab = () => (
    <div className="space-y-6">
      <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-lg font-semibold text-blue-800">üéØ Îπ†Î•∏ ÏÑ§Ï†ï</h3>
          <div className="flex gap-2">
            {editQuickSettings && (
              <button
                onClick={handleAddCard}
                className="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 transition-colors"
              >
                + Ï∂îÍ∞Ä
              </button>
            )}
            <button
              onClick={handleEditQuickSettings}
              className={`px-3 py-1 rounded text-sm transition-colors ${
                editQuickSettings
                  ? 'bg-red-600 text-white hover:bg-red-700'
                  : 'bg-blue-600 text-white hover:bg-blue-700'
              }`}
            >
              {editQuickSettings ? 'ÏôÑÎ£å' : 'Ìé∏Ïßë'}
            </button>
          </div>
        </div>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {quickSettings.map((card) => (
            <div
              key={card.id}
              className={`bg-white p-4 rounded-lg shadow-sm border border-gray-200 transition-all ${
                editQuickSettings
                  ? 'cursor-default'
                  : 'hover:shadow-md cursor-pointer'
              } ${editQuickSettings ? 'relative' : ''}`}
              onClick={() => !editQuickSettings && handleCardClick(card)}
            >
              {editQuickSettings && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    handleDeleteCard(card.id);
                  }}
                  className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-colors"
                >
                  √ó
                </button>
              )}
              <div className="flex items-center space-x-3">
                <div
                  className={`w-10 h-10 rounded-lg flex items-center justify-center ${getColorClasses(
                    card.color
                  )}`}
                >
                  <span className="text-xl">{card.icon}</span>
                </div>
                <div>
                  <h4 className="font-medium text-gray-900">{card.title}</h4>
                  <p className="text-sm text-gray-500">{card.description}</p>
                </div>
              </div>
            </div>
          ))}

          {editQuickSettings && showAddCard && (
            <div className="bg-white p-4 rounded-lg shadow-sm border-2 border-blue-300">
              <h4 className="font-medium text-gray-900 mb-3">ÏÉà Ïπ¥Îìú Ï∂îÍ∞Ä</h4>
              <div className="space-y-3">
                <input
                  type="text"
                  placeholder="Ï†úÎ™©"
                  value={newCard.title}
                  onChange={(e) =>
                    setNewCard({ ...newCard, title: e.target.value })
                  }
                  className="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                />
                <input
                  type="text"
                  placeholder="ÏÑ§Î™Ö"
                  value={newCard.description}
                  onChange={(e) =>
                    setNewCard({ ...newCard, description: e.target.value })
                  }
                  className="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                />
                <div className="flex gap-2">
                  <input
                    type="text"
                    placeholder="ÏïÑÏù¥ÏΩò (Ïù¥Î™®ÏßÄ)"
                    value={newCard.icon}
                    onChange={(e) =>
                      setNewCard({ ...newCard, icon: e.target.value })
                    }
                    className="flex-1 border border-gray-300 rounded px-3 py-2 text-sm"
                  />
                  <select
                    value={newCard.color}
                    onChange={(e) =>
                      setNewCard({ ...newCard, color: e.target.value })
                    }
                    className="border border-gray-300 rounded px-3 py-2 text-sm"
                  >
                    <option value="blue">ÌååÎûë</option>
                    <option value="green">Ï¥àÎ°ù</option>
                    <option value="purple">Î≥¥Îùº</option>
                    <option value="red">Îπ®Í∞ï</option>
                    <option value="yellow">ÎÖ∏Îûë</option>
                    <option value="indigo">ÎÇ®ÏÉâ</option>
                  </select>
                </div>
                <input
                  type="text"
                  placeholder="Í≤ΩÎ°ú (Ïòà: /Dashboard/settings)"
                  value={newCard.path}
                  onChange={(e) =>
                    setNewCard({ ...newCard, path: e.target.value })
                  }
                  className="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                />
                <div className="flex gap-2">
                  <button
                    onClick={handleSaveNewCard}
                    className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 transition-colors"
                  >
                    Ï†ÄÏû•
                  </button>
                  <button
                    onClick={() => setShowAddCard(false)}
                    className="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600 transition-colors"
                  >
                    Ï∑®ÏÜå
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
        {editQuickSettings && (
          <div className="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p className="text-sm text-yellow-800">
              üí° Ìé∏Ïßë Î™®Îìú: Ïπ¥ÎìúÎ•º ÌÅ¥Î¶≠ÌïòÏó¨ ÏÇ≠Ï†úÌïòÍ±∞ÎÇò "+ Ï∂îÍ∞Ä" Î≤ÑÌäºÏúºÎ°ú ÏÉà
              Ïπ¥ÎìúÎ•º ÎßåÎì§ Ïàò ÏûàÏäµÎãàÎã§.
            </p>
          </div>
        )}
      </div>
    </div>
  );

  const renderHospitalTab = () => (
    <div className="space-y-6">
      <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <h3 className="text-lg font-semibold mb-4">üè• Î≥ëÏõê Ï†ïÎ≥¥ Í¥ÄÎ¶¨</h3>
        <p className="text-gray-600 mb-4">Î≥ëÏõêÏùò Í∏∞Î≥∏ Ï†ïÎ≥¥Î•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</p>
        <button
          className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
          onClick={() => navigate('/Dashboard/hospital-info')}
        >
          Î≥ëÏõê Ï†ïÎ≥¥ Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        </button>
      </div>

      <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <h3 className="text-lg font-semibold mb-4">üìã ÏßÑÎ£åÍ≥º Í¥ÄÎ¶¨</h3>
        <div className="space-y-3">
          <div className="flex items-center justify-between p-3 bg-gray-50 rounded">
            <span>Î≥¥Ï≤†Í≥º</span>
            <span className="text-green-600 text-sm">ÌôúÏÑ±</span>
          </div>
          <div className="flex items-center justify-between p-3 bg-gray-50 rounded">
            <span>ÍµêÏ†ïÍ≥º</span>
            <span className="text-green-600 text-sm">ÌôúÏÑ±</span>
          </div>
          <div className="flex items-center justify-between p-3 bg-gray-50 rounded">
            <span>ÏπòÏ£ºÍ≥º</span>
            <span className="text-green-600 text-sm">ÌôúÏÑ±</span>
          </div>
        </div>
      </div>
    </div>
  );

  const renderUsersTab = () => (
    <div className="space-y-6">
      <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <h3 className="text-lg font-semibold mb-4">üë• ÏÇ¨Ïö©Ïûê Í∂åÌïú Í¥ÄÎ¶¨</h3>
        <p className="text-gray-600 mb-4">ÏÇ¨Ïö©ÏûêÎ≥Ñ Í∂åÌïúÍ≥º Ïó≠Ìï†ÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</p>
        <button
          className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
          onClick={() => navigate('/Dashboard/user-permissions')}
        >
          ÏÇ¨Ïö©Ïûê Í∂åÌïú Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
        </button>
      </div>

      <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <h3 className="text-lg font-semibold mb-4">üìä ÏÇ¨Ïö©Ïûê ÌÜµÍ≥Ñ</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div className="text-center p-4 bg-blue-50 rounded-lg">
            <div className="text-2xl font-bold text-blue-600">12</div>
            <div className="text-sm text-gray-600">Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê</div>
          </div>
          <div className="text-center p-4 bg-green-50 rounded-lg">
            <div className="text-2xl font-bold text-green-600">8</div>
            <div className="text-sm text-gray-600">ÌôúÏÑ± ÏÇ¨Ïö©Ïûê</div>
          </div>
          <div className="text-center p-4 bg-yellow-50 rounded-lg">
            <div className="text-2xl font-bold text-yellow-600">3</div>
            <div className="text-sm text-gray-600">Í¥ÄÎ¶¨Ïûê</div>
          </div>
        </div>
      </div>
    </div>
  );

  const renderTabContent = () => {
    switch (activeTab) {
      case 'general':
        return renderGeneralTab();
      case 'hospital':
        return renderHospitalTab();
      case 'users':
        return renderUsersTab();
      default:
        return null;
    }
  };

  return (
    <div className="p-4 sm:p-6 md:p-8 bg-gray-50 min-h-screen">
      <div className="mb-6">
        <h2 className="text-2xl font-bold text-gray-900">‚öôÔ∏è Ï†ÑÏ≤¥ ÏÑ§Ï†ï</h2>
        <p className="text-gray-600 mt-1">ÏãúÏä§ÌÖúÏùò Î™®Îì† ÏÑ§Ï†ïÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</p>
      </div>

      <div className="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
        <div className="flex overflow-x-auto">
          {tabs.map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex items-center space-x-2 px-6 py-4 text-sm font-medium whitespace-nowrap border-b-2 transition-colors ${
                activeTab === tab.id
                  ? 'border-blue-500 text-blue-600 bg-blue-50'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'
              }`}
            >
              <span>{tab.icon}</span>
              <span>{tab.label}</span>
            </button>
          ))}
        </div>
      </div>

      <div className="bg-white rounded-lg shadow-md mt-6">
        <div className="p-4 sm:p-6">{renderTabContent()}</div>
      </div>
    </div>
  );
};

export default GeneralSettings;
